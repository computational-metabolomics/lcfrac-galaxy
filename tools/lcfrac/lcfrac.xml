<tool id="lcfrac" name="LC-MS/MS fractionation processor - " version="0.0.11">
    <description>
        Combine and process spectra and annotation results from an LC-MS(/MS) fractionation experiment
    </description>
    <requirements>
        <requirement type="package" version="1.0.0">msnpy</requirement>
    </requirements>
    <stdio>
        <regex match="Cannot allocate memory"
           source="stderr"
           level="fatal_oom"
           description="Out of memory error occurred" />
    </stdio>
    <command detect_errors="exit_code">
    <![CDATA[

       python '$__tool_directory__/lcfrac/lcfrac/__main__.py'
                   --lcms_sqlite '$lcms_sqlite'
                   --dims_pls='
                        #for $i in $dims_pls
                            $i.element_identifier,$i,
                        #end for
                      '
                   --dimsn_merged='
                        #for $i in $dimsn_merged
                            $i.element_identifier,$i,
                        #end for
                      '
                   --dimsn_non_merged='
                        #for $i in $dimsn_non_merged
                            $i.element_identifier,$i,
                        #end for
                      '
                   --dimsn_ms1_precursors='
                        #for $i in $dimsn_ms1_precursors
                            $i.element_identifier,$i,
                        #end for
                      '
                   --beams='
                        #for $i in $beams
                            $i.element_identifier,$i,
                        #end for
                      '
                   --metfrag='
                        #for $i in $metfrag
                            $i.element_identifier,$i,
                        #end for
                      '
                   --sirius='
                        #for $i in $sirius
                            $i.element_identifier,$i,
                        #end for
                      '
                   --spectral_matching='
                        #for $i in $spectral_matching
                            $i.element_identifier,$i,
                        #end for
                   '

                   --mf_annotation='
                        #for $i in $mf_annotation
                            $i.element_identifier,$i,
                        #end for
                   '
                   --additional_info='
                        #for $i in $additional_info
                            $i.element_identifier,$i,
                        #end for
                   '
                   --frac_times_pth '$__tool_directory__/lcfrac/lcfrac/frac_times.csv'
                   --lcms_ppm $lcms_ppm
                   --dims_ppm $dims_ppm
                   --time_tolerance $time_tolerance
                   --rank_limit $rank_limit
                   --sirius_rank_limit $sirius_rank_limit
                   --galaxy

                   $ms1_lookup_checkAdducts
                    --ms1_lookup_keepAdducts="$ms1_lookup_keepAdducts"

                   #if $comp_db_cond.comp_db_type== 'user'
                        --comp_db_pth=$comp_db_cond.comp_db
                   #end if

                   #if $library_db_cond.library_db_type== 'user'
                        --library_db_pth=$library_db_cond.library_db
                   #end if

                   --out_sqlite '$summary_results_sqlite'
                   --out_tsv '$summary_results_tsv'


    ]]></command>
    <inputs>
        <param argument="--lcms_sqlite" type="data" format="sqlite"
               label="LC-MS(/MS) SQlite results"/>
        <param argument="--dims_pls" type="data_collection"  format="h5"
               label="DIMS peaklist for fractions"/>
        <param argument="--dimsn_merged" type="data_collection" format="h5" multiple="true"
               label="DIMSn merged"/>
        <param argument="--dimsn_non_merged" type="data_collection" format="h5" multiple="true"
               label="DIMSn non merged"/>
        <param argument="--dimsn_ms1_precursors" type="data_collection" format="h5" multiple="true"
               label="DIMSn MS1 precursors"/>
        <param argument="--beams" type="data_collection" format="tsv,tabular" multiple="true"
               label="BEAMS MS1 annotation results for DIMS"/>
        <param argument="--metfrag" type="data_collection" format="tsv,tabular" multiple="true"
               label="Metfrag results for DIMSn"/>
        <param argument="--sirius" type="data_collection" format="tsv,tabular" multiple="true"
               label="SIRIUS CSI:FingerID results for DIMSn"/>
        <param argument="--spectral_matching" type="data_collection" format="tsv,tabular" multiple="true"
               label="Spectral matching results for DIMSn"/>
        <param argument="--mf_annotation" type="data_collection" format="tsv,tabular" multiple="true"
               label="Molecular formula annotation based on MSn (MSnPy)"/>
        <param argument="--additional_info" type="data_collection" format="tsv,tabular" multiple="true"
               label="Additional details"
               help="A peak table with additional columns to include in the database (e.g. isotope, adducts, precursor
                      ion purity"/>
        <param argument="--lcms_ppm" type="float" value="5"
               label="PPM error for LC-MS measurements"/>
        <param argument="--dims_ppm" type="float" value="5"
               label="PPM error for DI-MS measurements"/>
        <param argument="--time_tolerance" type="float" value="10"
               label="Tolerance in seconds to map DIMS to LC-MS"/>
        <param name="sm_weight" type="float" min="0.0" max="1.0" value="0.3"
               label="Spectral matching weight" help="all weights need to sum to 1" />
        <param name="metfrag_weight" type="float" min="0.0" max="1.0" value="0.2"
               label="Metfrag weight" help="all weights need to sum to 1" />
        <param name="sirius_csi_weight" type="float" min="0.0" max="1.0" value="0.2"
               label="Sirius CSI:FingerID weight" help="all weights need to sum to 1" />
        <param name="beams_weight" type="float" min="0.0" max="1.0" value="0.05" label="MS1 Lookup weight"
               help="all weights need to sum to 1" />
        <param name="biosim_weight" type="float" min="0.0" max="1.0" value="0.25"
               label="Biological similarity weight" help="all weights need to sum to 1" />
        <param name="create_new_database" type="boolean" checked="true" label="Create a new database for the results?"
               help="A copy will be made of the input SQLite spectral matching database and the results will
                     be added to this copy.
                     When False, the input SQLite database will be updated the results. Use False
                     if you want to reduce storage space being used."/>
        <param name="ms1_lookup_dbSource" type="select" label="MS1 lookup database source"
               help="Which database was used for the MS1 lookup with BEAMS" >
                <option value="hmdb" selected="true">hmdb</option>
                <option value="pubchem">pubchem</option>
                <option value="kegg">kegg</option>
        </param>
        <param name="ms1_lookup_keepAdducts" type="text" label="MS1 lookup adducts to keep" optional="true"
               help="Provide a list of adducts that should be used from the MS1 lookup (e.g. [M+H]+, [M+Na]+)"/>
        <param name="ms1_lookup_checkAdducts" type="boolean" label="MS1 lookup check adducts to CAMERA"
               truevalue="--ms1_lookup_checkAdducts" falsevalue=""
               help="Check if adducts match to those found in CAMERA (adducts to be present in the additional
                     peak information file)"/>
        <param argument="--sirius_rank_limit" type="integer" value="25" label="Limit for sirius annotations by rank"
               help="Limit the number of annotations from SIRIUS CSI:FingerID "/>
        <param argument="--rank_limit" type="integer" value="0" label="Limit for annotations by rank"
               help="Only applies to the summary tsv table (leave as zero to include all annotations)"/>

        <conditional name="comp_db_cond">
            <param name="comp_db_type" type="select" label="Compound database"
                   help="Database type for compound database to be used full database available
                   on request - contact t.n.lawson@bham.ac.uk)." >
                <option value="user" selected="true">User SQLite database</option>
                <option value="local_config"  >Locally configured SQLite database</option>
            </param>
            <when value="user">
               <param type="data" name="comp_db" label="SQLite compound database" format="sqlite" help=""/>
            </when>
            <when value="local_config">
            </when>
        </conditional>

        <conditional name="library_db_cond">
            <param name="library_db_type" type="select" label="Spectral library database"
                   help="Database type for spectral library" >
                <option value="user" selected="true">User SQLite database</option>
                <option value="local_config"  >Locally configured SQLite database</option>
            </param>
            <when value="user">
               <param type="data" name="library_db" label="SQLite of spectral library"
                      format="sqlite" help=""/>
            </when>
            <when value="local_config">
            </when>
        </conditional>



    </inputs>
    <outputs>
        <data name="summary_results_tsv" format="tsv"/>
        <data name="summary_results_sqlite" format="sqlite"/>
    </outputs>
    <tests>
        <test>
            <param name="dims_pls" >
                <collection type="list">
                    <element name="A01" value="dims_pls/A01.h5"/>
                    <element name="A02" value="dims_pls/A02.h5"/>
                </collection>
            </param>
            <param name="dimsn_trees" >
                <collection type="list">
                    <element name="A01" value="dimsn_trees/A01.json"/>
                    <element name="A02_1" value="dimsn_trees/A02_1.json"/>
                    <element name="A02_2" value="dimsn_trees/A02_2.json"/>
                </collection>
            </param>
            <param name="beams" >
                <collection type="list">
                    <element name="A01" value="beams/A01.tsv"/>
                    <element name="A02" value="beams/A02.tsv"/>
                </collection>
            </param>
            <param name="metfrag" >
                <collection type="list">
                    <element name="A01" value="metfrag/A01.tabular"/>
                    <element name="A02_1" value="metfrag/A02_1.tabular"/>
                </collection>
            </param>
            <param name="sirius" >
                <collection type="list">
                    <element name="A01" value="sirius/A01.tsv"/>
                    <element name="A02_1" value="sirius/A02_1.tsv"/>
                    <element name="A02_2" value="sirius/A02_2.tsv"/>
                </collection>
            </param>
            <param name="spectral_matching" >
                <collection type="list">
                    <element name="A01" value="spectral_matching/A01.tsv"/>
                    <element name="A02_1" value="spectral_matching/A02_1.tsv"/>
                </collection>
            </param>
            <param name="additional_info" >
                <collection type="list">
                    <element name="A01" value="additional/A01.tsv"/>
                    <element name="A02" value="additional/A02.tsv"/>
                </collection>
            </param>
            <param name="lcms_sqlite" value="lcmsms.sqlite"/>
            <param name="library_db_type" value="local_config"/>
            <param name="comp_db" value="metab_compound_subset.sqlite"/>
            <param name="library_db" value=""/>
            <output name="summary_results_tsv" value="summary_results.tsv"/>
<!--            <output name="summary_results_sqlite" value="summary_results.sqlite"/>-->
        </test>
    </tests>
    <help>
-------
LC-Frac
-------


    </help>
    <citations>
        <citation type="doi">x</citation>
    </citations>
</tool> 
